<!DOCTYPE html>
<html lang="es">

<head>
    <title>Book Joy</title>
    <%- include('./partials/head.ejs') %>
</head>

<body>
    <header class="container-fluid py-3 bg-dark text-white">
        <%- include('./partials/header.ejs') %>
    </header>

    <!-- Hero a pantalla completa (full width) -->
    <section class="hero-search mb-5">
        <div class="hero-search__overlay py-5">
            <div class="container">
                <h1 class="text-center text-white mb-4">Reserva tu apartamento en Book Joy</h1>

                <div class="card shadow-sm hero-search__card mx-auto">
                    <div class="card-body">

                        <!-- Formulario para buscar el apartamento (mantiene los mismos names que usa el controlador) -->
                        <form action="/search" method="get" class="row g-3 mb-0">

                            <!-- Huéspedes (capacidad mínima) -->
                            <div class="col-12 col-sm-6 col-md-3">
                                <label for="guests" class="form-label">Huéspedes</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fa-solid fa-user-group"></i></span>
                                    <input type="number" min="1" name="guests" id="guests" class="form-control"
                                        value="<%= filters?.guests || '' %>">
                                </div>
                            </div>

                            <!-- Ciudad -->
                            <div class="col-12 col-sm-6 col-md-3">
                                <label for="city" class="form-label">Ciudad</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fa-solid fa-location-dot"></i></span>
                                    <input type="text" name="city" id="city" class="form-control"
                                        value="<%= filters?.city || '' %>">
                                </div>
                            </div>

                            <!-- Fechas -->
                            <!-- Fecha de entrada -->
                            <div class="col-6 col-md-2">
                                <label for="startDate" class="form-label">Entrada</label>
                                <input type="date" class="form-control" name="startDate" id="startDate"
                                    value="<%= filters?.startDate || '' %>">
                            </div>

                            <!-- Fecha de salida -->
                            <div class="col-6 col-md-2">
                                <label for="endDate" class="form-label">Salida</label>
                                <input type="date" class="form-control" name="endDate" id="endDate"
                                    value="<%= filters?.endDate || '' %>">
                            </div>

                            <!-- Precio -->
                            <div class="col-6 col-md-1">
                                <label for="minPrice" class="form-label">Mín (€)</label>
                                <input type="number" min="0" name="minPrice" id="minPrice" class="form-control"
                                    value="<%= filters?.minPrice || '' %>">
                            </div>
                            <div class="col-6 col-md-1">
                                <label for="maxPrice" class="form-label">Máx (€)</label>
                                <input type="number" min="0" name="maxPrice" id="maxPrice" class="form-control"
                                    value="<%= filters?.maxPrice || '' %>">
                            </div>

                            <!-- Ordenar -->
                            <div class="col-12 col-md-3">
                                <label for="sort" class="form-label">Ordenar por</label>
                                <select name="sort" id="sort" class="form-select">
                                    <option value="">—</option>
                                    <option value="price_asc" <%=(filters?.sort==='price_asc' ) ? 'selected' : '' %>
                                        >Precio ↑</option>
                                    <option value="price_desc" <%=(filters?.sort==='price_desc' ) ? 'selected' : '' %>
                                        >Precio ↓</option>
                                    <option value="m2_asc" <%=(filters?.sort==='m2_asc' ) ? 'selected' : '' %>>m² ↑
                                    </option>
                                    <option value="m2_desc" <%=(filters?.sort==='m2_desc' ) ? 'selected' : '' %>>m² ↓
                                    </option>
                                </select>
                            </div>

                            <!-- Botones -->
                            <div class="col-12 col-md-3 d-flex gap-2 align-items-end">
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="fa-solid fa-magnifying-glass me-1"></i> Buscar
                                </button>
                                <a href="/" class="btn btn-outline-secondary" title="Limpiar filtros">
                                    <i class="fa-solid fa-rotate-left"></i>
                                </a>
                            </div>

                        </form>
                    </div>
                </div>

                <!-- Contador de resultados -->
                <div class="text-center mt-3">
                    <span class="badge bg-light text-dark">
                        <strong>
                            <%= (allApartments && allApartments.length) || 0 %>
                        </strong> resultados
                    </span>
                </div>
            </div>
        </div>
    </section>

    <!-- Grid de apartamentos -->
    <main class="container my-5">
        <section class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
            <% allApartments.forEach(function(apt) { const mainPhoto=apt.photos?.find(p=> p.isMain) || apt.photos?.[0]
                || {};
                %>
                <div class="col">
                    
                    <%# Card del apartamento (position-relative para poder ubicar el badge encima) %>
                    <div class="card h-100 shadow-sm position-relative">
                        <%# Badge de ciudad (esquina superior izquierda) %>
                        <span class="badge bg-dark text-uppercase fw-semibold position-absolute"
                            style="top:.5rem; left:.5rem; letter-spacing:.02em;">
                            <%= apt.location?.city || 'Sin ciudad' %>
                        </span>

                        <img src="<%= mainPhoto.url || '/placeholder.jpg' %>" class="card-img-top"
                            alt="<%= apt.title %>">


                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title">
                                <%= apt.title %>
                            </h5>
                            <p class="card-text mb-1"><strong>Precio:</strong> €<%= apt.price %> / noche</p>
                            <p class="card-text mb-1"><strong>Superficie:</strong>
                                <%= apt.squareMeters %> m²
                            </p>
                            <p class="card-text mb-2"><strong>Capacidad:</strong>
                                <%= apt.maxGuests %> personas
                            </p>

                            <%# Íconos de los servicios %>
                                <div class="d-flex flex-wrap gap-3 text-dark mt-3 mb-3">

                                    <% if (apt.services?.wifi) { %>
                                        <span title="Wi-Fi"><i class="fa-solid fa-wifi"></i></span>
                                        <% } %>

                                            <% if (apt.services?.parking) { %>
                                                <span title="Parking"><i class="fa-solid fa-square-parking"></i></span>
                                                <% } %>

                                                    <% if (apt.services?.disability) { %>
                                                        <span title="Accesible"><i
                                                                class="fa-brands fa-accessible-icon"></i></span>
                                                        <% } %>

                                                            <% if (apt.services?.airConditioning) { %>
                                                                <span title="Aire acondicionado"><i
                                                                        class="fa-solid fa-snowflake"></i></span>
                                                                <% } %>

                                                                    <% if (apt.services?.heating) { %>
                                                                        <span title="Calefacción"><i
                                                                                class="fa-solid fa-fire"></i></span>
                                                                        <% } %>

                                                                            <% if (apt.services?.tv) { %>
                                                                                <span title="Televisión"><i
                                                                                        class="fa-solid fa-tv"></i></span>
                                                                                <% } %>

                                                                                    <% if (apt.services?.kitchen) { %>
                                                                                        <span title="Cocina"><i
                                                                                                class="fa-solid fa-kitchen-set"></i></span>
                                                                                        <% } %>

                                                                                            <% if
                                                                                                (apt.services?.internet)
                                                                                                { %>
                                                                                                <span
                                                                                                    title="Internet"><i
                                                                                                        class="fa-solid fa-globe"></i></span>
                                                                                                <% } %>
                                </div>

                                <a href="/apartment/<%= apt._id %>" class="btn btn-outline-primary mt-auto">Ver
                                    detalles</a>
                        </div>
                    </div>
                </div>
                <% }); %>
        </section>

    </main>
</body>

</html>